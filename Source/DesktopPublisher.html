<html>
<body>

<div id="divMain">

<!-- ui begins -->

<div>

<label><b>Desktop Publisher</b></label><br />
<p>Enter a document as JSON, upload any content files, and click the buttons to display the document's pages or to export them as a .tar file.</p>

<label>Document:</label><br />

<button onclick="buttonLoadDemoDocument_Clicked();">Load Demo Document</button>
<br />

<label>Load Document from .doc.tar:</label>
<input type="file" onchange="inputDocumentFileToLoad_Changed(this);" />
<br />

<button onclick="buttonSaveDocument_Clicked();">Save Document as .doc.tar</button>
<br />

<label>Content Files:</label>
<br />
<select id="selectContentFiles" size="4" readonly="true"></select>
<br />
<label>Upload New:</label>
<input type="file" onchange="inputContentFileToUpload_Changed(this);" />
<br />

<label>Document Layout as JSON:</label><br />
<textarea id="textareaLayoutAsJson" cols="80" rows="16" wrap="off" ></textarea>
</div>

<div>
	<button onclick="buttonRender_Clicked();">Render as Images</button>
	<button onclick="buttonExport_Clicked();">Export as .png.tar</button>
</div>

<div id="divOutput" />

<!-- ui ends -->

</div>


<script type="text/javascript">

function buttonLoadDemoDocument_Clicked()
{
	var documentNew = Document.demo();

	var documentNewAsJson = JSON.stringify(documentNew, null, 4);
	var textareaLayoutAsJson = document.getElementById("textareaLayoutAsJson");
	textareaLayoutAsJson.value = documentNewAsJson;

	var contentFiles = documentNew.textFiles;
	var contentFilesAsSelectOptions = contentFiles.map
	(
		x =>
		{
			var returnValue = document.createElement("option")
			returnValue.value = x.name;
			returnValue.innerHTML = x.name;
			return returnValue;
		}
	);
	var selectContentFiles = document.getElementById("selectContentFiles");
	selectContentFiles.innerHTML = "";
	contentFilesAsSelectOptions.forEach(x => selectContentFiles.appendChild(x));
}

function buttonRender_Clicked()
{
	var textareaLayoutAsJson = document.getElementById("textareaLayoutAsJson");
	var layoutAsJson = textareaLayoutAsJson.value;

	var selectContentFiles = document.getElementById("selectContentFiles");
	var contentFilesAsOptions = selectContentFiles.options;
	var contentFiles = [];
	for (var i = 0; i < contentFilesAsOptions.length; i++)
	{
		var contentFileAsOption = contentFilesAsOptions[i];
		var contentFile = contentFileAsOption.value; // todo - Value must be a string?
		contentFiles.push(contentFile);
	}
	var documentToDisplay = Document.fromLayoutJsonAndContentFiles(layoutAsJson, contentFiles);
	documentToDisplay.initialize();
	documentToDisplay.update();
	documentToDisplay.draw();
}

function buttonExport_Clicked()
{
	var documentToExport = documentParseAndLayOut();
	var documentAsTarFile = documentToExport.toTarFile();
	var documentAsBytes = documentAsTarFile.toBytes();
	FileHelper.saveBytesAsFile(documentAsBytes, documentToExport.name + "png.tar");
}

function buttonSaveDocument_Clicked()
{
	var textareaLayoutAsJson = document.getElementById("textareaLayoutAsJson");
	var layoutAsJson = textareaLayoutAsJson.value;
	var layoutAsTarFileEntry = TarFileEntry.fromString("Layout.json.txt", layoutAsJson);
	var contentFiles = [];
	for (var i = 0; i < contentFilesAsOptions.length; i++)
	{
		var contentFileAsOption = contentFilesAsOptions[i];
		var contentFile = contentFileAsOption.value; // todo - Value must be a string?
		contentFiles.push(contentFile);
	}
	var contentFilesAsTarFileEntries = contentFiles.map
	(
		x => TarFileEntry.fromString(x.name, x.text)
	);
	FileHelper.saveBytesAsFile(documentAsBytes, documentToExport.name + ".doc.tar");
}

function inputContentFileToUpload_Changed(inputContentFileToUpload)
{
	var fileToLoad = inputContentFileToUpload.files[0];
	if (fileToLoad != null)
	{
		FileHelper.loadFileAsBytes
		(
			fileToLoad,
			fileAsBytes =>
			{
				var fileContentAsString = ByteHelper.bytesToStringUTF8(fileAsBytes);
				var fileAsTextString = new TextStringFromFile
				(
					fileToLoad.name,
					fileToLoad.name, // sourcePath
					fileContentAsString
				);
				var fileAsSelectOption = document.createElement("option");
				fileAsSelectOption.value = fileAsTextString.text;
				fileAsSelectOption.innerHTML = fileAsTextString.name;
				var selectContentFiles = document.getElementById("selectContentFiles");
				selectContentFiles.appendChild(fileAsSelectOption);
			}
		);
	}
}

function inputDocumentFileToLoad_Changed(inputDocumentFileToLoad)
{
	var fileToLoad = inputDocumentFileToLoad.files[0];
	if (fileToLoad != null)
	{
		FileHelper.loadFileAsBytes
		(
			fileToLoad,
			fileAsBytes =>
			{
				var documentAsTarFile = TarFile.fromBytes(fileAsBytes);

				var layoutAsTarFileEntry = documentAsTarFile.entries["Layout.json.txt"];
				var layoutAsBytes = layoutAsTarFileEntry.dataAsBytes;
				var layoutAsJson = ByteHelper.bytesToStringUTF8(layoutAsBytes);
				var textareaLayoutAsJson = document.getElementById("textareaLayoutAsJson");
				textareaLayoutAsJson.value = layoutAsJson;

				var selectContentFiles = document.getElementById("selectContentFiles");
				var contentFilesAsTarFileEntries = documentAsTarFile.entries.slice(0);
				var contentFilesAsTextStringsFromFiles = contentFilesAsTarFileEntries.map
				(
					x => new TextStringFromFile(x.name, ByteHelper.bytesToStringUTF8(x.dataAsBytes) )
				);
				selectContentFiles.appendChild();
			}
		);
	}
}

</script>

<script type="text/javascript" src="Extensions/ArrayExtensions.js"></script>
<script type="text/javascript" src="Extensions/StringExtensions.js"></script>

<script type="text/javascript" src="ContentAssignment.js"></script>
<script type="text/javascript" src="ContentBlock.js"></script>
<script type="text/javascript" src="ContentType.js"></script>
<script type="text/javascript" src="Coords.js"></script>
<script type="text/javascript" src="Display.js"></script>
<script type="text/javascript" src="Document.js"></script>
<script type="text/javascript" src="Font.js"></script>
<script type="text/javascript" src="Page.js"></script>
<script type="text/javascript" src="PageDefn.js"></script>
<script type="text/javascript" src="Zone.js"></script>
<script type="text/javascript" src="ZoneDefn.js"></script>
<script type="text/javascript" src="ByteHelper.js"></script>
<script type="text/javascript" src="ByteStream.js"></script>
<script type="text/javascript" src="FileHelper.js"></script>
<script type="text/javascript" src="TextStringFromFile.js"></script>

<script type="text/javascript" src="Tar/TarFile.js"></script>
<script type="text/javascript" src="Tar/TarFileEntry.js"></script>
<script type="text/javascript" src="Tar/TarFileEntryHeade.js"></script>
<script type="text/javascript" src="Tar/TarFileTypeFlag.js"></script>

