<html>
<body>

<div id="divMain">

<!-- ui begins -->

<div>

<label><b>Desktop Publisher</b></label><br />
<p>Enter a document as JSON, upload any content files, and click the buttons to display the document's pages or to export them as a .tar file.</p>

<label>Document:</label><br />

<button onclick="buttonLoadDemoDocument_Clicked();">Load Demo Document</button>
<br />

<label>Load Document from .doc.tar:</label>
<input type="file" onchange="inputDocumentFileToLoad_Changed(this);" />
<br />

<button onclick="buttonSaveDocument_Clicked();">Save Document as .doc.tar</button>
<br />

<label>Name:</label>
<input id="inputDocumentName"></input>
<br />

<label>Content Files:</label>
<br />
<select id="selectContentFiles" size="4" readonly="true"></select>
<br />
<label>Upload New:</label>
<input type="file" onchange="inputContentFileToUpload_Changed(this);" />
<br />

<label>Document Layout as JSON:</label><br />
<textarea id="textareaLayoutAsJson" cols="80" rows="16" wrap="off" ></textarea>
</div>

<div>
	<button onclick="buttonDraw_Clicked();">Render as Images</button>
	<button onclick="buttonExport_Clicked();">Export as .png.tar</button>
</div>

<div id="divOutput" />

<!-- ui ends -->

</div>

<script type="text/javascript">

function buttonLoadDemoDocument_Clicked()
{
	var d = document;

	var documentNew = Document.demo();
	Session.Instance.document = documentNew;
	controlsPopulate();
}

function controlsPopulate()
{
	var d = document;
	var documentToPopulateFrom = Session.Instance.document;

	var inputDocumentName = d.getElementById("inputDocumentName");
	inputDocumentName.value = documentToPopulateFrom.name;

	var documentToPopulateFromAsJson = JSON.stringify(documentToPopulateFrom, null, 4);
	var textareaLayoutAsJson = d.getElementById("textareaLayoutAsJson");
	textareaLayoutAsJson.value = documentToPopulateFromAsJson;

	var contentFiles = documentToPopulateFrom.textFiles;
	var contentFilesAsSelectOptions = contentFiles.map
	(
		x =>
		{
			var returnValue = document.createElement("option")
			returnValue.value = x.name;
			returnValue.innerHTML = x.name;
			return returnValue;
		}
	);
	var selectContentFiles = d.getElementById("selectContentFiles");
	selectContentFiles.innerHTML = "";
	contentFilesAsSelectOptions.forEach(x => selectContentFiles.appendChild(x));
}

function buttonDraw_Clicked()
{
	var documentToDisplay = Session.Instance.document;
	documentToDisplay.initialize();
	documentToDisplay.update();
	documentToDisplay.draw();
}

function buttonExport_Clicked()
{
	var documentToExport = Session.Instance.document;
	var documentAsTarFile = documentToExport.toTarFile_Png();
	var documentAsBytes = documentAsTarFile.toBytes();
	FileHelper.saveBytesAsFile(documentAsBytes, documentToExport.name + ".png.tar");
}

function buttonSaveDocument_Clicked()
{
	var documentToSave = Session.Instance.document;
	var documentAsTarFile = documentToSave.toTarFile();
	var documentAsBytes = documentAsTarFile.toBytes();
	FileHelper.saveBytesAsFile
	(
		documentAsBytes, documentToSave.name + ".doc.tar"
	);
}

function inputContentFileToUpload_Changed(inputContentFileToUpload)
{
	var contentFileToLoad = inputContentFileToUpload.files[0];
	if (contentFileToLoad != null)
	{
		FileHelper.loadFileAsBytes
		(
			contentFileToLoad,
			contentFileAsBytes =>
			{
				var fileContentAsString = ByteHelper.bytesToStringUTF8(fileAsBytes);
				var fileAsTextString = new TextStringFromFile
				(
					fileToLoad.name,
					fileToLoad.name, // sourcePath
					fileContentAsString
				);
				Session.Instance.document.textFiles = fileAsTextString;
				controlsPopulate();
			}
		);
	}
}

function inputDocumentFileToLoad_Changed(inputDocumentFileToLoad)
{
	var fileToLoad = inputDocumentFileToLoad.files[0];
	if (fileToLoad != null)
	{
		FileHelper.loadFileAsBytes
		(
			fileToLoad,
			(fileName, fileAsBytes) =>
			{
				var documentAsTarFile = TarFile.fromBytes(fileName, fileAsBytes);
				var document = Document.fromTarFile(documentAsTarFile);
				Session.Instance.document = document;
				controlsPopulate();
			}
		);
	}
}

</script>

<script type="text/javascript" src="Extensions/ArrayExtensions.js"></script>
<script type="text/javascript" src="Extensions/StringExtensions.js"></script>

<script type="text/javascript" src="ByteHelper.js"></script>
<script type="text/javascript" src="ByteStream.js"></script>
<script type="text/javascript" src="ContentAssignment.js"></script>
<script type="text/javascript" src="ContentBlock.js"></script>
<script type="text/javascript" src="ContentType.js"></script>
<script type="text/javascript" src="Coords.js"></script>
<script type="text/javascript" src="Display.js"></script>
<script type="text/javascript" src="Document.js"></script>
<script type="text/javascript" src="FileHelper.js"></script>
<script type="text/javascript" src="Font.js"></script>
<script type="text/javascript" src="Page.js"></script>
<script type="text/javascript" src="PageDefn.js"></script>
<script type="text/javascript" src="Session.js"></script>
<script type="text/javascript" src="TextStringFromFile.js"></script>
<script type="text/javascript" src="Zone.js"></script>
<script type="text/javascript" src="ZoneDefn.js"></script>

<script type="text/javascript" src="Tar/TarFile.js"></script>
<script type="text/javascript" src="Tar/TarFileEntry.js"></script>
<script type="text/javascript" src="Tar/TarFileEntryHeader.js"></script>
<script type="text/javascript" src="Tar/TarFileTypeFlag.js"></script>

</body>
</html>
